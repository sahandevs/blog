<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><link href="https://fonts.googleapis.com/css?family=Source Code Pro" rel="stylesheet"/><meta name="generator" content="Gatsby 4.25.9"/><meta data-react-helmet="true" charSet="utf-8"/><meta data-react-helmet="true" property="og:title" content="جادوی Context"/><meta data-react-helmet="true" property="og:site_name" content="Sahand&#x27;s blog"/><style data-href="/styles.1906a6c925635f62b029.css" data-identity="gatsby-global-css">:root{--lr-padding:10px;--border-radius:8px;--primary-color-active:#ff7e14;--primary-color-inactive:#ffd1ac;--secondary-color:#fffcf9;--anim-duration:300ms;--paragraph-width:calc(min(760px, 100%));--code-width:min(100%,calc(var(--paragraph-width) + 12%));--paragraph-padding:calc((var(--code-width) - var(--paragraph-width))/2);font-size:16px}.footnotes,.main-container h1,.text,a,em,h2,h3,h4,h5,h6,li,p,ul{direction:rtl;font-family:Vazir,monospace,Source Code Pro!important;line-height:1.6}.main-container h1,h2,h3,h4,h5,h6{padding-left:var(--paragraph-padding);padding-right:var(--paragraph-padding)}.text a{overflow-wrap:anywhere}.footnotes li{color:#5c6e74;font-size:.8rem!important}.main-container-wrapper{align-items:center;display:flex;flex-direction:column;width:100%}.main-container p{margin:0}a{text-decoration:none}a,a:hover{color:var(--primary-color-active)}a:hover{text-decoration:underline}.main-container{padding-top:1rem;width:var(--code-width)}.main-container img{display:block;margin-left:auto;margin-right:auto;max-height:500px;max-width:80%}.main-container .img-container{max-width:100%}@media screen and (max-width:768px){:root{--lr-padding:10%}}@media screen and (max-width:375px){:root{--lr-padding:5%}.main-container{margin-top:0;padding-top:0!important}.main-container h1{margin-top:10px}.main-container blockquote{margin:25px 0 0}.main-container img{max-width:100%;vertical-align:top}.main-container .img-container{overflow-x:auto}}.main-container li{font-size:1.2rem;margin-left:var(--paragraph-padding);margin-right:var(--paragraph-padding);margin-top:.6rem;padding:0;text-align:justify}.main-container p,.text{font-size:1.2rem;padding-left:var(--paragraph-padding);padding-right:var(--paragraph-padding);text-align:justify}.main-container blockquote .text{--h-space:10px;--v-space:4px;background-color:#e7e7e7;border-radius:var(--border-radius);border-right:5px solid var(--primary-color-inactive);margin-left:calc(var(--paragraph-padding)*1.3);margin-right:calc(var(--paragraph-padding)*1.3);padding:var(--v-space) var(--h-space);transition:border-right var(--anim-duration)}.main-container blockquote .text:hover{border-right-color:var(--primary-color-active)}.resources .text{direction:ltr;font-size:.8rem;text-align:start}.main-container code{background-color:#f1f1f1;border-radius:var(--border-radius);direction:ltr!important;font-size:1.1rem;padding-left:6px;padding-right:6px;text-align:left;white-space:nowrap}.playground-button{background-color:var(--primary-color-active);border-bottom-left-radius:var(--border-radius);padding:0 5px;position:absolute;right:0;top:0}.playground-button a{color:#fff;font-size:.8rem;margin:0}.playground-button a:hover{text-decoration:none}code[class*=language-],pre[class*=language-]{color:#5c6e74;direction:ltr;font-family:Source Code Pro,Andale Mono,Ubuntu Mono,monospace;font-size:1rem;-webkit-hyphens:none;hyphens:none;line-height:1.5;tab-size:4;text-align:left;text-shadow:none;white-space:pre;word-break:normal;word-spacing:normal}code[class*=language-]::mozselection,code[class*=language-]::selection,pre[class*=language-]::mozselection,pre[class*=language-]::selection{background:#b3d4fc;text-shadow:none}@media print{code[class*=language-],pre[class*=language-]{text-shadow:none}}pre[class*=language-]{background:var(--secondary-color);border:1px solid var(--primary-color-inactive);border-radius:var(--border-radius);margin:.5em 0;overflow:auto;padding:.8em;transition:border var(--anim-duration)}pre[class*=language-]:hover{border:1px solid var(--primary-color-active)}:not(pre)>code[class*=language-]{background:#f9f2f4;border-radius:.3em;color:#db4c69;padding:.1em .3em}.namespace{opacity:.7}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#93a1a1}.token.punctuation{color:#999}.token.boolean,.token.constant,.token.deleted,.token.number,.token.property,.token.symbol,.token.tag{color:#905}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string{color:#690}.language-css .token.string,.style .token.string,.token.entity,.token.operator,.token.url{background:#fff;color:#a67f59}.token.atrule,.token.attr-value,.token.keyword{color:#07a}.token.function{color:#dd4a68}.token.important,.token.regex,.token.variable{color:#e90}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}pre[data-line]{position:relative}pre[class*=language-]>code[class*=language-]{position:relative;z-index:1}.line-highlight{background:#f7ebc6;box-shadow:inset 5px 0 0 #f7d87c;left:0;line-height:inherit;margin-top:1em;padding-bottom:inherit;padding-left:0;padding-right:0;padding-top:inherit;pointer-events:none;position:absolute;right:0;white-space:pre;z-index:0}.footnotes,.post-list-container h1,.text,a,em,h2,h3,h4,h5,h6,li,p,ul{font-family:Vazir,monospace,Source Code Pro!important;line-height:1.6;margin:0;padding:0}.post-list-container ul{list-style-type:circle;padding:0}.post-list-container li a{color:#121212;text-decoration-style:dotted}.post-list-container li{margin-top:16px}.category-container .badge{background-color:var(--primary-color-active);border-radius:5px;color:#fff;margin-left:5px;padding-left:4px;padding-right:4px}.post-list-container{direction:rtl;display:flex;flex-direction:row;flex-wrap:wrap;padding:3rem}.category-container{margin:2rem 1rem;width:calc(50% - 2rem)}.category-container .hr{background-color:var(--primary-color-active);border-radius:5px;height:5px;margin-bottom:1rem;margin-top:.1rem;width:40%}@media screen and (max-width:425px){.category-container{width:100%}.post-list-container{padding:1rem}}.social{display:flex;flex-direction:row;font-family:Source Code Pro!important;font-size:.9rem;justify-content:center;margin-top:20px;width:100%}.social a{color:grey!important;opacity:.6;transition:.2s}.social a:hover{opacity:1}.social p{margin-left:10px;margin-right:10px}</style><style>.gatsby-image-wrapper{position:relative;overflow:hidden}.gatsby-image-wrapper picture.object-fit-polyfill{position:static!important}.gatsby-image-wrapper img{bottom:0;height:100%;left:0;margin:0;max-width:none;padding:0;position:absolute;right:0;top:0;width:100%;object-fit:cover}.gatsby-image-wrapper [data-main-image]{opacity:0;transform:translateZ(0);transition:opacity .25s linear;will-change:opacity}.gatsby-image-wrapper-constrained{display:inline-block;vertical-align:top}</style><noscript><style>.gatsby-image-wrapper noscript [data-main-image]{opacity:1!important}.gatsby-image-wrapper [data-placeholder-image]{opacity:0!important}</style></noscript><script type="module">const e="undefined"!=typeof HTMLImageElement&&"loading"in HTMLImageElement.prototype;e&&document.body.addEventListener("load",(function(e){const t=e.target;if(void 0===t.dataset.mainImage)return;if(void 0===t.dataset.gatsbyImageSsr)return;let a=null,n=t;for(;null===a&&n;)void 0!==n.parentNode.dataset.gatsbyImageWrapper&&(a=n.parentNode),n=n.parentNode;const o=a.querySelector("[data-placeholder-image]"),r=new Image;r.src=t.currentSrc,r.decode().catch((()=>{})).then((()=>{t.style.opacity=1,o&&(o.style.opacity=0,o.style.transition="opacity 500ms linear")}))}),!0);</script><title data-react-helmet="true">جادوی Context</title><link rel="sitemap" type="application/xml" href="/sitemap/sitemap-index.xml"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div class="main-container-wrapper"><div class="main-container"><div class="text">🚧🚧🚧🚧🚧🚧🚧🚧🚧🚧🚧🚧🚧🚧🚧در دست نگارش🚧🚧🚧🚧🚧🚧🚧🚧🚧🚧🚧🚧🚧🚧🚧</div><h1>جادوی Context</h1><div class="text">بعضا وقتا که با API
بعضی از فریمورک‌ها کار می‌کنیم، یکسری API
دارن که به نظر می‌رسه با جادو کار می‌کنن. مثلا چیزی مثل
<code dir="ltr">useContext</code> داخل ری‌اکت. چطوری بهم Context
درست رو برمی‌گردونه؟ یا داخل فریم‌ورک های وب‌سرور Node
چطوری بعضی از فانکشن‌ها بدون اینکه ما <code dir="ltr">req</code> رو بهشون بدیم،
میفهمن باید با کدوم <code dir="ltr">req</code> کار کنن؟</div><div class="text">بیایم از ری‌اکت که ساده‌ترینشون هست شروع کنیم و همینطوری بریم مثال های پیچیده‌تر رو نگاه کنیم ببینیم چطوری کار می‌کنن. آخر هم یک نتیجه‌گیری کنیم
که کلا این سیستم‌ها از چه مکانیزمی استفاده می‌کنن.</div><h2>useContext داخل ری‌اکت</h2><div class="text">احتمالا اگه با ری‌اکت کار کرده باشید، با Context هم آشنا هستید. اگر هم نه یک توضیح خیلی سادش اینه، فرض کنید همچین
چینشی برای کامپوننت هاتون دارید.</div><div style="position:relative"><pre class="prism-code language-jsx"><div class="token-line"><span class="token tag punctuation">&lt;</span><span class="token tag class-name">TopComponent</span><span class="token tag punctuation">&gt;</span><span class="token plain-text"></span></div><div class="token-line"><span class="token plain-text">    </span><span class="token tag punctuation">&lt;</span><span class="token tag class-name">MiddleComponent1</span><span class="token tag punctuation">&gt;</span><span class="token plain-text"></span></div><div class="token-line"><span class="token plain-text">        </span><span class="token tag punctuation">&lt;</span><span class="token tag class-name">MiddleComponent2</span><span class="token tag punctuation">&gt;</span><span class="token plain-text"></span></div><div class="token-line"><span class="token plain-text">            </span><span class="token tag punctuation">&lt;</span><span class="token tag class-name">Inner</span><span class="token tag punctuation">&gt;</span><span class="token plain-text"></span></div><div class="token-line"><span class="token plain-text">        </span><span class="token tag punctuation">&lt;</span><span class="token tag class-name">MiddleComponent2</span><span class="token tag punctuation">&gt;</span><span class="token plain-text"></span></div><div class="token-line"><span class="token plain-text">    </span><span class="token tag punctuation">&lt;/</span><span class="token tag class-name">MiddleComponent1</span><span class="token tag punctuation">&gt;</span><span class="token plain-text"></span></div><div class="token-line"><span class="token plain-text"></span><span class="token tag punctuation">&lt;/</span><span class="token tag class-name">TopComponent</span><span class="token tag punctuation">&gt;</span></div></pre></div><div class="text">حالا فرض کنید میخواید یکسری دیتا از بالا به کامپوننت <code dir="ltr">Inner</code> بفرستید بدون که لازم باشه از props استفاده کنید. می‌تونید با <code dir="ltr">Provider</code> اونو ست کنید:</div><div style="position:relative"><pre class="prism-code language-diff"><div class="token-line"><span class="token inserted-sign inserted prefix inserted">+</span><span class="token inserted-sign inserted line">&lt;MyContext.Provider value={{ user: &quot;username&quot; }}&gt;</span></div><div class="token-line"><span class="token inserted-sign inserted line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">   &lt;TopComponent&gt;</span></div><div class="token-line"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">       &lt;MiddleComponent1&gt;</span></div><div class="token-line"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">           &lt;MiddleComponent2&gt;</span></div><div class="token-line"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">               &lt;Inner&gt;</span></div><div class="token-line"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">           &lt;MiddleComponent2&gt;</span></div><div class="token-line"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">       &lt;/MiddleComponent1&gt;</span></div><div class="token-line"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">   &lt;/TopComponent&gt;</span></div><div class="token-line"><span class="token unchanged line"></span><span class="token inserted-sign inserted prefix inserted">+</span><span class="token inserted-sign inserted line">&lt;/MyContext.Provider&gt;</span></div></pre></div><div class="text">و با <code dir="ltr">useContext()</code> اونو پایین تر دریافت کنید:</div><div style="position:relative"><pre class="prism-code language-jsx"><div class="token-line"><span class="token keyword">function</span><span class="token plain"> </span><span class="token function maybe-class-name">Inner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> user </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">useContext</span><span class="token punctuation">(</span><span class="token maybe-class-name">MyContext</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token plain">user</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token comment">// username</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// ...</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><div class="text">خب پیاده‌سازی همچین چیزی ساده بنظر می‌رسه، میتونیم مقدارشو توی یک متغییر استاتیک ذخیره کنیم و با <code dir="ltr">useContext</code> اونو برش گردونیم.
توی مثال بالا این پیاده‌سازی جواب میده ولی با Context ری‌اکت میشه کارهای پیچیده‌تری کرد. مثلا میشه اونو تو در تو تعریف کرد:</div><div style="position:relative"><pre class="prism-code language-jsx"><div class="token-line"><span class="token tag punctuation">&lt;</span><span class="token tag class-name">MyContext.Provider</span><span class="token tag"> </span><span class="token tag attr-name">value</span><span class="token tag script language-javascript script-punctuation punctuation">=</span><span class="token tag script language-javascript punctuation">{</span><span class="token tag script language-javascript punctuation">{</span><span class="token tag script language-javascript"> </span><span class="token tag script language-javascript literal-property property">user</span><span class="token tag script language-javascript operator">:</span><span class="token tag script language-javascript"> </span><span class="token tag script language-javascript string">&quot;username1&quot;</span><span class="token tag script language-javascript"> </span><span class="token tag script language-javascript punctuation">}</span><span class="token tag script language-javascript punctuation">}</span><span class="token tag punctuation">&gt;</span><span class="token plain-text"></span></div><div class="token-line"><span class="token plain-text">    </span><span class="token tag punctuation">&lt;</span><span class="token tag class-name">TopComponent</span><span class="token tag punctuation">&gt;</span><span class="token plain-text"></span></div><div class="token-line"><span class="token plain-text">        </span><span class="token tag punctuation">&lt;</span><span class="token tag class-name">MiddleComponent1</span><span class="token tag punctuation">&gt;</span><span class="token plain-text"></span></div><div class="token-line"><span class="token plain-text">            </span><span class="token tag punctuation">&lt;</span><span class="token tag class-name">MyContext.Provider</span><span class="token tag"> </span><span class="token tag attr-name">value</span><span class="token tag script language-javascript script-punctuation punctuation">=</span><span class="token tag script language-javascript punctuation">{</span><span class="token tag script language-javascript punctuation">{</span><span class="token tag script language-javascript"> </span><span class="token tag script language-javascript literal-property property">user</span><span class="token tag script language-javascript operator">:</span><span class="token tag script language-javascript"> </span><span class="token tag script language-javascript string">&quot;username2&quot;</span><span class="token tag script language-javascript"> </span><span class="token tag script language-javascript punctuation">}</span><span class="token tag script language-javascript punctuation">}</span><span class="token tag punctuation">&gt;</span><span class="token plain-text"></span></div><div class="token-line"><span class="token plain-text">                </span><span class="token tag punctuation">&lt;</span><span class="token tag class-name">MiddleComponent2</span><span class="token tag punctuation">&gt;</span><span class="token plain-text"></span></div><div class="token-line"><span class="token plain-text">                    </span><span class="token tag punctuation">&lt;</span><span class="token tag class-name">Inner</span><span class="token tag punctuation">&gt;</span><span class="token plain-text"></span></div><div class="token-line"><span class="token plain-text">                </span><span class="token tag punctuation">&lt;</span><span class="token tag class-name">MiddleComponent2</span><span class="token tag punctuation">&gt;</span><span class="token plain-text"></span></div><div class="token-line"><span class="token plain-text">            </span><span class="token tag punctuation">&lt;/</span><span class="token tag class-name">MyContext.Provider</span><span class="token tag punctuation">&gt;</span><span class="token plain-text"></span></div><div class="token-line"><span class="token plain-text">        </span><span class="token tag punctuation">&lt;/</span><span class="token tag class-name">MiddleComponent1</span><span class="token tag punctuation">&gt;</span><span class="token plain-text"></span></div><div class="token-line"><span class="token plain-text">    </span><span class="token tag punctuation">&lt;/</span><span class="token tag class-name">TopComponent</span><span class="token tag punctuation">&gt;</span><span class="token plain-text"></span></div><div class="token-line"><span class="token plain-text"></span><span class="token tag punctuation">&lt;/</span><span class="token tag class-name">MyContext.Provider</span><span class="token tag punctuation">&gt;</span></div></pre></div><div class="text">یا حتی توی شاخه‌های مختلف کامپوننت هامون ازش استفاده کرد:</div><div style="position:relative"><pre class="prism-code language-jsx"><div class="token-line"><span class="token tag punctuation">&lt;</span><span class="token tag punctuation">&gt;</span><span class="token plain-text"></span></div><div class="token-line"><span class="token plain-text">    </span><span class="token tag punctuation">&lt;</span><span class="token tag class-name">MyContext.Provider</span><span class="token tag"> </span><span class="token tag attr-name">value</span><span class="token tag script language-javascript script-punctuation punctuation">=</span><span class="token tag script language-javascript punctuation">{</span><span class="token tag script language-javascript punctuation">{</span><span class="token tag script language-javascript"> </span><span class="token tag script language-javascript literal-property property">user</span><span class="token tag script language-javascript operator">:</span><span class="token tag script language-javascript"> </span><span class="token tag script language-javascript string">&quot;username1&quot;</span><span class="token tag script language-javascript"> </span><span class="token tag script language-javascript punctuation">}</span><span class="token tag script language-javascript punctuation">}</span><span class="token tag punctuation">&gt;</span><span class="token plain-text"></span></div><div class="token-line"><span class="token plain-text">        </span><span class="token tag punctuation">&lt;</span><span class="token tag class-name">Inner</span><span class="token tag punctuation">&gt;</span><span class="token plain-text"></span></div><div class="token-line"><span class="token plain-text">    </span><span class="token tag punctuation">&lt;/</span><span class="token tag class-name">MyContext.Provider</span><span class="token tag punctuation">&gt;</span><span class="token plain-text"></span></div><div class="token-line"><span class="token plain-text">    </span><span class="token tag punctuation">&lt;</span><span class="token tag class-name">MyContext.Provider</span><span class="token tag"> </span><span class="token tag attr-name">value</span><span class="token tag script language-javascript script-punctuation punctuation">=</span><span class="token tag script language-javascript punctuation">{</span><span class="token tag script language-javascript punctuation">{</span><span class="token tag script language-javascript"> </span><span class="token tag script language-javascript literal-property property">user</span><span class="token tag script language-javascript operator">:</span><span class="token tag script language-javascript"> </span><span class="token tag script language-javascript string">&quot;username2&quot;</span><span class="token tag script language-javascript"> </span><span class="token tag script language-javascript punctuation">}</span><span class="token tag script language-javascript punctuation">}</span><span class="token tag punctuation">&gt;</span><span class="token plain-text"></span></div><div class="token-line"><span class="token plain-text">        </span><span class="token tag punctuation">&lt;</span><span class="token tag class-name">Inner</span><span class="token tag punctuation">&gt;</span><span class="token plain-text"></span></div><div class="token-line"><span class="token plain-text">    </span><span class="token tag punctuation">&lt;/</span><span class="token tag class-name">MyContext.Provider</span><span class="token tag punctuation">&gt;</span><span class="token plain-text"></span></div><div class="token-line"><span class="token plain-text"></span><span class="token tag punctuation">&lt;/</span><span class="token tag punctuation">&gt;</span></div></pre></div><div class="text">که خب این قابلیت رو نمیشه با یک متغییر استاتیک ساده پیاده سازی کرد. یا حداقل نه به این سادگی‌ها!
می‌دونیم که توی مرورگر کد جاوااسکریپتمون سینگل‌ترد اجرا می‌شه. یعنی موازی دو تیکه از کد اجرا نمی‌شن.
اگه توی زمان‌های درستی این متغییر استاتیک یا گلوبال رو با مقدار درستش پر بکنیم، کافیه <code dir="ltr">useContext</code>
همون مقدار متغییر گلوبالمون رو برگردونه.</div><div class="text">خب مثال اولمون رو در نظر بگیرید:</div><div style="position:relative"><pre class="prism-code language-jsx"><div class="token-line"><span class="token tag punctuation">&lt;</span><span class="token tag class-name">MyContext.Provider</span><span class="token tag"> </span><span class="token tag attr-name">value</span><span class="token tag script language-javascript script-punctuation punctuation">=</span><span class="token tag script language-javascript punctuation">{</span><span class="token tag script language-javascript punctuation">{</span><span class="token tag script language-javascript"> </span><span class="token tag script language-javascript literal-property property">user</span><span class="token tag script language-javascript operator">:</span><span class="token tag script language-javascript"> </span><span class="token tag script language-javascript string">&quot;username&quot;</span><span class="token tag script language-javascript"> </span><span class="token tag script language-javascript punctuation">}</span><span class="token tag script language-javascript punctuation">}</span><span class="token tag punctuation">&gt;</span><span class="token plain-text"></span></div><div class="token-line"><span class="token plain-text">    </span><span class="token tag punctuation">&lt;</span><span class="token tag class-name">TopComponent</span><span class="token tag punctuation">&gt;</span><span class="token plain-text"></span></div><div class="token-line"><span class="token plain-text">        </span><span class="token tag punctuation">&lt;</span><span class="token tag class-name">MiddleComponent1</span><span class="token tag punctuation">&gt;</span><span class="token plain-text"></span></div><div class="token-line"><span class="token plain-text">            </span><span class="token tag punctuation">&lt;</span><span class="token tag class-name">MiddleComponent2</span><span class="token tag punctuation">&gt;</span><span class="token plain-text"></span></div><div class="token-line"><span class="token plain-text">                </span><span class="token tag punctuation">&lt;</span><span class="token tag class-name">Inner</span><span class="token tag punctuation">&gt;</span><span class="token plain-text"></span></div><div class="token-line"><span class="token plain-text">            </span><span class="token tag punctuation">&lt;</span><span class="token tag class-name">MiddleComponent2</span><span class="token tag punctuation">&gt;</span><span class="token plain-text"></span></div><div class="token-line"><span class="token plain-text">        </span><span class="token tag punctuation">&lt;/</span><span class="token tag class-name">MiddleComponent1</span><span class="token tag punctuation">&gt;</span><span class="token plain-text"></span></div><div class="token-line"><span class="token plain-text">    </span><span class="token tag punctuation">&lt;/</span><span class="token tag class-name">TopComponent</span><span class="token tag punctuation">&gt;</span><span class="token plain-text"></span></div><div class="token-line"><span class="token plain-text"></span><span class="token tag punctuation">&lt;/</span><span class="token tag class-name">MyContext.Provider</span><span class="token tag punctuation">&gt;</span></div></pre></div><div class="text">رندرر ری‌اکت میاد این درخت رو پیمایش میکنه از بالا تا پایین شروع میکنه:</div><ul><li>به <code>MyContext.Provider</code> پس مقدار <code>MyContext.currentValue = { user: &quot;username&quot; }</code> میشه</li><li>می‌رسه به TopComponent و vdom رو می‌سازه.</li><li>به MiddleComponent1 می‌رسه و اونو هم رندر می‌کنه.</li><li>به MiddleComponent2 می‌رسه و اونو هم رندر می‌کنه.</li><li>در نهایت به <code>Inner</code> می‌رسه و <code>useContext</code> مقدار <code>MyContext.currentValue</code> رو برمی‌گردونه که همون <code>{ user: &quot;username&quot; }</code> هست.</li></ul><div class="text">بریم به یک مثال پیچیده‌تر هم نگاه کنیم:</div><div style="position:relative"><pre class="prism-code language-jsx"><div class="token-line"><span class="token tag punctuation">&lt;</span><span class="token tag class-name">MyContext.Provider</span><span class="token tag"> </span><span class="token tag attr-name">value</span><span class="token tag script language-javascript script-punctuation punctuation">=</span><span class="token tag script language-javascript punctuation">{</span><span class="token tag script language-javascript punctuation">{</span><span class="token tag script language-javascript"> </span><span class="token tag script language-javascript literal-property property">user</span><span class="token tag script language-javascript operator">:</span><span class="token tag script language-javascript"> </span><span class="token tag script language-javascript string">&quot;username1&quot;</span><span class="token tag script language-javascript"> </span><span class="token tag script language-javascript punctuation">}</span><span class="token tag script language-javascript punctuation">}</span><span class="token tag punctuation">&gt;</span><span class="token plain-text"></span></div><div class="token-line"><span class="token plain-text">    </span><span class="token tag punctuation">&lt;</span><span class="token tag class-name">MyContext.Provider</span><span class="token tag"> </span><span class="token tag attr-name">value</span><span class="token tag script language-javascript script-punctuation punctuation">=</span><span class="token tag script language-javascript punctuation">{</span><span class="token tag script language-javascript punctuation">{</span><span class="token tag script language-javascript"> </span><span class="token tag script language-javascript literal-property property">user</span><span class="token tag script language-javascript operator">:</span><span class="token tag script language-javascript"> </span><span class="token tag script language-javascript string">&quot;username2&quot;</span><span class="token tag script language-javascript"> </span><span class="token tag script language-javascript punctuation">}</span><span class="token tag script language-javascript punctuation">}</span><span class="token tag punctuation">&gt;</span><span class="token plain-text"></span></div><div class="token-line"><span class="token plain-text">       </span><span class="token tag punctuation">&lt;</span><span class="token tag class-name">Inner</span><span class="token tag punctuation">&gt;</span><span class="token plain-text"></span></div><div class="token-line"><span class="token plain-text">    </span><span class="token tag punctuation">&lt;/</span><span class="token tag class-name">MyContext.Provider</span><span class="token tag punctuation">&gt;</span><span class="token plain-text"></span></div><div class="token-line"><span class="token plain-text">    </span><span class="token tag punctuation">&lt;</span><span class="token tag class-name">Inner</span><span class="token tag punctuation">&gt;</span><span class="token plain-text"></span></div><div class="token-line"><span class="token plain-text"></span><span class="token tag punctuation">&lt;/</span><span class="token tag class-name">MyContext.Provider</span><span class="token tag punctuation">&gt;</span></div></pre></div><div class="text">توی این مثال چی؟ اگه مثل قبل عمل کنیم که به <code dir="ltr">Inner</code> دومی مقدار <code dir="ltr">username2</code> می‌رسه.
اینجاست که باید خود فریم‌ورک بهمون یک هوک بده تا بتونیم زمان خروج رندرد یک کامپوننت رو بفهمیم.
یعنی چی؟ فرض کنید ترتیب اجرا عملیات رندرر بصورت زیر هست:</div><div style="position:relative"><pre class="prism-code language-undefined"><div class="token-line"><span class="token plain">enter(MyContext.Provider)</span></div><div class="token-line"><span class="token plain">render()</span></div><div class="token-line"><span class="token plain">  enter(MyContext.Provider)</span></div><div class="token-line"><span class="token plain">  render()</span></div><div class="token-line"><span class="token plain">    enter(Inner)</span></div><div class="token-line"><span class="token plain">    render()</span></div><div class="token-line"><span class="token plain">    exit(Inner)</span></div><div class="token-line"><span class="token plain">  exit(MyContext.Provider)</span></div><div class="token-line"><span class="token plain">exit(MyContext.Provider)</span></div></pre></div><div class="text">حالا ما توی اون متغییر گلوبال اگه بیایم یک درخت درست کنیم که موقع <code dir="ltr">enter</code> برای هر <code dir="ltr">Context</code>
اونو به درخت اضافه کنه و موقع <code dir="ltr">exit</code> آخرین برگ درخت رو حذف کنه،
اگه داخل <code dir="ltr">useContext</code> آخرین برگ این درخت رو بخونیم، همیشه مقدار درستی رو خواهیم داشت!</div><h2>AsyncLocalStorage داخل Nodejs</h2><div style="position:relative"><pre class="prism-code language-javascript"><div class="token-line"><span class="token keyword">const</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> </span><span class="token maybe-class-name">AsyncLocalStorage</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;async_hooks&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> myAsyncLocalStorage </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">AsyncLocalStorage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">middleware</span><span class="token punctuation">(</span><span class="token parameter">req</span><span class="token parameter punctuation">,</span><span class="token parameter"> res</span><span class="token parameter punctuation">,</span><span class="token parameter"> next</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  myAsyncLocalStorage</span><span class="token punctuation">.</span><span class="token method function property-access">run</span><span class="token punctuation">(</span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    myAsyncLocalStorage</span><span class="token punctuation">.</span><span class="token method function property-access">getStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">set</span><span class="token punctuation">(</span><span class="token string">&#x27;userId&#x27;</span><span class="token punctuation">,</span><span class="token plain"> req</span><span class="token punctuation">.</span><span class="token property-access">headers</span><span class="token punctuation">[</span><span class="token string">&#x27;x-user-id&#x27;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">async</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">requestHandler</span><span class="token punctuation">(</span><span class="token parameter">req</span><span class="token parameter punctuation">,</span><span class="token parameter"> res</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> store </span><span class="token operator">=</span><span class="token plain"> myAsyncLocalStorage</span><span class="token punctuation">.</span><span class="token method function property-access">getStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> userId </span><span class="token operator">=</span><span class="token plain"> store</span><span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token string">&#x27;userId&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  res</span><span class="token punctuation">.</span><span class="token method function property-access">send</span><span class="token punctuation">(</span><span class="token template-string template-punctuation string">`</span><span class="token template-string string">Hello user </span><span class="token template-string interpolation interpolation-punctuation punctuation">${</span><span class="token template-string interpolation">userId</span><span class="token template-string interpolation interpolation-punctuation punctuation">}</span><span class="token template-string template-punctuation string">`</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><div class="text">خب توی ری‌اکت رندرینگ رو می‌دونیم که در یک لحظه فقط برای یک کامپوننت در حال اجراست، پس می‌شه توی
زمان مناسب اون متغییر گلوبال رو با مقدار درستش پر کرد. ولی برای یک وب‌سرور توی Node
که همزمان ممکنه چندین ری‌کوئست بصورت async
در حال اجرا باشن، رو می‌تونیم چیکار کنیم.
توی کد بالا ما اومدیم برای express که یک وب‌سرور هست، یک پلاگین نوشتیم که میاد یک هدر رو از توی ریکو‌‌ئست می‌خونه و یکجا دخیره میکنه.
و پایین‌تر توی هندلرمون بدون اینکه مستقیم اون به ری‌کوئست داده باشیم می‌تونیم بخونیم.
این <code dir="ltr">AsyncLocalStorage</code> چطوری می‌تونه بفهمه باید مقدار درست رو برگردونه؟</div><div class="text">اینجا هم جاوا اسکریپت سینگل‌ترد هست ولی محیطمون داخلش همزمانی وجود داره، پس اگه بخوایم از یک
متغییر گلوبال استفاده کنیم ممکنه همزمان پیش بیاد.
همچنین مثل ری‌اکت ما چیزی مثل کامپوننت نداریم که بدونیم کی
enter شد و exit شد تا در زمان مناسب مقدار مناسبی توی متغییر گلوبال ذخیره کنیم.</div><div class="text">یادمون باشه اینجا همزمانی وجود داره ولی این همزمانی فقط برای کارهای IO است.
یعنی اگه یک کار sync داریم انجام می‌دیم، هیچ کار sync دیگه‌ای انجام نمیشه.</div><div class="text">همینطور هر ریکو‌‌يست یک task به صورت async یا یک Promise درست می‌کنه.</div><div class="text">خب حالا اگه به یک طریقی بفهمیم در یک لحظه CPU دست کدوم
Promise هست، میتونیم اینو پیاده سازی کنیم.</div><div class="text">انجین‌های مختلفی برای جاوااسکریپت هست که یکیش v8 هست.
این انجین به ما یه چیزی به نام PromiseHooks بهمون میده، خیلی خلاصه و ساده
هر وقت یک Promise شروع میکنه به یک کار IO
و ایونت‌لوپ میاد تا وقتی کار IO تموم میشه یک Promise
دیگه‌رو جلو می‌بره، می‌تونیم هوک‌مون رو صدا بزنیم.
پس عملا می‌تونیم بفهمیم که یک promise داره
enter می‌شه و کی اون داره
exit می‌شه.</div><div class="text">این درخت عملا چیزی مثل call stack هست
ولی برای promise task ها.
که اگه یک تسک داخل یک تسک اجرا بشه اینجا درختشو داریم.</div><div class="text">حالا توی <code dir="ltr">run</code> کافیه توی
promise فعلی مقداری که میخوایم رو ذخیره کنیم
و هر وقت خواستیم مقدار رو پایین‌تر بخونیم کافیه درخت رو پیمایش کنیم و بریم تا وقتی که به مقداری که می‌خوایم برسیم:</div><div class="text"><a href="https://github.com/supabase/edge-runtime/blob/main/crates/node/polyfills/internal/async_hooks.ts" dir="ltr">اینجا</a> می‌تونید یک پیاده‌سازی کامل از AsyncLocalStorage رو ببینید.</div><h2>Thread-local storage داخل سیستم عامل</h2><div class="text">توی AsyncLocalStorage فهمیدیم پیاده‌سازیش از این فرض که
جاوا‌اسکریپت سینگل‌ترد هست استفاده می‌کنه که اون متغییر استاتیک رو آپدیت نگه‌داره. حالا اگه برنام‌مون توی یک زبانی باشه
که بشه مولتی‌ترد کار کرد چی. اینو باید چیکار کنیم؟!</div><div class="text">به کد C زیر نگاه کنید:</div><div style="position:relative"><pre class="prism-code language-c"><div class="token-line"><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword">include</span><span class="token macro property"> </span><span class="token macro property string">&lt;stdio.h&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword">include</span><span class="token macro property"> </span><span class="token macro property string">&lt;pthread.h&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">__thread </span><span class="token keyword">int</span><span class="token plain"> counter</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">void</span><span class="token operator">*</span><span class="token plain"> </span><span class="token function">thread_function</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token plain"> arg</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    counter </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token class-name">size_t</span><span class="token punctuation">)</span><span class="token plain">arg</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Thread %d: counter = %d\n&quot;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token class-name">size_t</span><span class="token punctuation">)</span><span class="token plain">arg</span><span class="token punctuation">,</span><span class="token plain"> counter</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">int</span><span class="token plain"> </span><span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token class-name">pthread_t</span><span class="token plain"> threads</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">    </span><span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token plain">threads</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token plain"> thread_function</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token plain">threads</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token plain"> thread_function</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">    </span><span class="token function">pthread_join</span><span class="token punctuation">(</span><span class="token plain">threads</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">pthread_join</span><span class="token punctuation">(</span><span class="token plain">threads</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><div class="text">توی مثال بالا با اینکه دوتا ترد دارن یک متغییر گلوبال رو می‌خونن ولی مشکل data-race بوجود نمیاد.
چرا؟ چون این متغییر گلوبال به صورت Thread-local storage تعریف شده.
که خب توی زبان c میشه یک استاتیک با پی‌شوند <code dir="ltr">__thread</code> تبدیل به <code dir="ltr">TLS</code> کرد.</div><div class="text">پیاده‌سازی های مختلفی از TLS هست که یکیش مال pthread ئه.
چیکار می‌کنه؟</div><div class="text">TODO:</div><div class="text">توضیحات کامل‌ترشو می‌تونید توی <a href="https://www.akkadia.org/drepper/tls.pdf" dir="ltr">این</a> مقاله بخونید.</div><h2>نتیجه‌گیری</h2><div class="text">TODO:</div><hr/><h3>منابع</h3><div dir="ltr" class="resources"><div class="text">[<!-- -->1<!-- -->]<!-- -->: </div></div></div></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/context-magic/";window.___webpackCompilationHash="c103745651a3b464ca50";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app-1888b6368c0a709c8f93.js"],"component---src-pages-404-tsx":["/component---src-pages-404-tsx-d479770c8c96c1ac42f2.js"],"component---src-pages-context-magic-mdx":["/component---src-pages-context-magic-mdx-4b4e4dbf7124a0b0fb00.js"],"component---src-pages-index-tsx":["/component---src-pages-index-tsx-22c3dbbf0e0536d40b7e.js"],"component---src-pages-ratelimit-p-1-mdx":["/component---src-pages-ratelimit-p-1-mdx-ab74d2fc9b92877c5926.js"],"component---src-pages-ratelimit-p-2-mdx":["/component---src-pages-ratelimit-p-2-mdx-a831dc263d1b65146292.js"],"component---src-pages-usb-switcher-mdx":["/component---src-pages-usb-switcher-mdx-d2d9ce5fc9b3b3003e58.js"],"component---src-pages-v-8-ignition-mdx":["/component---src-pages-v-8-ignition-mdx-122560c660255bdbbf38.js"],"component---src-pages-v-8-jit-mdx":["/component---src-pages-v-8-jit-mdx-342275cde6b3adfce9f5.js"],"component---src-pages-v-8-mdx":["/component---src-pages-v-8-mdx-b1b5eabfe647d44e9a52.js"],"component---src-pages-v-8-parser-mdx":["/component---src-pages-v-8-parser-mdx-26d55d7ee79517093435.js"]};/*]]>*/</script><script src="/app-1888b6368c0a709c8f93.js" async=""></script><script src="/framework-2b6860fea1dc24d063ff.js" async=""></script><script src="/webpack-runtime-c251087d9a336ac50ffb.js" async=""></script></body></html>