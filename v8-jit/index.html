<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><link href="https://fonts.googleapis.com/css?family=Source Code Pro" rel="stylesheet"/><meta name="generator" content="Gatsby 4.25.9"/><meta data-react-helmet="true" charSet="utf-8"/><meta data-react-helmet="true" property="og:title" content="JIT Compiler چیه و چطور کار می‌کنه؟ - قسمت ۴"/><meta data-react-helmet="true" property="og:site_name" content="Sahand&#x27;s blog"/><style data-href="/styles.1906a6c925635f62b029.css" data-identity="gatsby-global-css">:root{--lr-padding:10px;--border-radius:8px;--primary-color-active:#ff7e14;--primary-color-inactive:#ffd1ac;--secondary-color:#fffcf9;--anim-duration:300ms;--paragraph-width:calc(min(760px, 100%));--code-width:min(100%,calc(var(--paragraph-width) + 12%));--paragraph-padding:calc((var(--code-width) - var(--paragraph-width))/2);font-size:16px}.footnotes,.main-container h1,.text,a,em,h2,h3,h4,h5,h6,li,p,ul{direction:rtl;font-family:Vazir,monospace,Source Code Pro!important;line-height:1.6}.main-container h1,h2,h3,h4,h5,h6{padding-left:var(--paragraph-padding);padding-right:var(--paragraph-padding)}.text a{overflow-wrap:anywhere}.footnotes li{color:#5c6e74;font-size:.8rem!important}.main-container-wrapper{align-items:center;display:flex;flex-direction:column;width:100%}.main-container p{margin:0}a{text-decoration:none}a,a:hover{color:var(--primary-color-active)}a:hover{text-decoration:underline}.main-container{padding-top:1rem;width:var(--code-width)}.main-container img{display:block;margin-left:auto;margin-right:auto;max-height:500px;max-width:80%}.main-container .img-container{max-width:100%}@media screen and (max-width:768px){:root{--lr-padding:10%}}@media screen and (max-width:375px){:root{--lr-padding:5%}.main-container{margin-top:0;padding-top:0!important}.main-container h1{margin-top:10px}.main-container blockquote{margin:25px 0 0}.main-container img{max-width:100%;vertical-align:top}.main-container .img-container{overflow-x:auto}}.main-container li{font-size:1.2rem;margin-left:var(--paragraph-padding);margin-right:var(--paragraph-padding);margin-top:.6rem;padding:0;text-align:justify}.main-container p,.text{font-size:1.2rem;padding-left:var(--paragraph-padding);padding-right:var(--paragraph-padding);text-align:justify}.main-container blockquote .text{--h-space:10px;--v-space:4px;background-color:#e7e7e7;border-radius:var(--border-radius);border-right:5px solid var(--primary-color-inactive);margin-left:calc(var(--paragraph-padding)*1.3);margin-right:calc(var(--paragraph-padding)*1.3);padding:var(--v-space) var(--h-space);transition:border-right var(--anim-duration)}.main-container blockquote .text:hover{border-right-color:var(--primary-color-active)}.resources .text{direction:ltr;font-size:.8rem;text-align:start}.main-container code{background-color:#f1f1f1;border-radius:var(--border-radius);direction:ltr!important;font-size:1.1rem;padding-left:6px;padding-right:6px;text-align:left;white-space:nowrap}.playground-button{background-color:var(--primary-color-active);border-bottom-left-radius:var(--border-radius);padding:0 5px;position:absolute;right:0;top:0}.playground-button a{color:#fff;font-size:.8rem;margin:0}.playground-button a:hover{text-decoration:none}code[class*=language-],pre[class*=language-]{color:#5c6e74;direction:ltr;font-family:Source Code Pro,Andale Mono,Ubuntu Mono,monospace;font-size:1rem;-webkit-hyphens:none;hyphens:none;line-height:1.5;tab-size:4;text-align:left;text-shadow:none;white-space:pre;word-break:normal;word-spacing:normal}code[class*=language-]::mozselection,code[class*=language-]::selection,pre[class*=language-]::mozselection,pre[class*=language-]::selection{background:#b3d4fc;text-shadow:none}@media print{code[class*=language-],pre[class*=language-]{text-shadow:none}}pre[class*=language-]{background:var(--secondary-color);border:1px solid var(--primary-color-inactive);border-radius:var(--border-radius);margin:.5em 0;overflow:auto;padding:.8em;transition:border var(--anim-duration)}pre[class*=language-]:hover{border:1px solid var(--primary-color-active)}:not(pre)>code[class*=language-]{background:#f9f2f4;border-radius:.3em;color:#db4c69;padding:.1em .3em}.namespace{opacity:.7}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#93a1a1}.token.punctuation{color:#999}.token.boolean,.token.constant,.token.deleted,.token.number,.token.property,.token.symbol,.token.tag{color:#905}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string{color:#690}.language-css .token.string,.style .token.string,.token.entity,.token.operator,.token.url{background:#fff;color:#a67f59}.token.atrule,.token.attr-value,.token.keyword{color:#07a}.token.function{color:#dd4a68}.token.important,.token.regex,.token.variable{color:#e90}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}pre[data-line]{position:relative}pre[class*=language-]>code[class*=language-]{position:relative;z-index:1}.line-highlight{background:#f7ebc6;box-shadow:inset 5px 0 0 #f7d87c;left:0;line-height:inherit;margin-top:1em;padding-bottom:inherit;padding-left:0;padding-right:0;padding-top:inherit;pointer-events:none;position:absolute;right:0;white-space:pre;z-index:0}.footnotes,.post-list-container h1,.text,a,em,h2,h3,h4,h5,h6,li,p,ul{font-family:Vazir,monospace,Source Code Pro!important;line-height:1.6;margin:0;padding:0}.post-list-container ul{list-style-type:circle;padding:0}.post-list-container li a{color:#121212;text-decoration-style:dotted}.post-list-container li{margin-top:16px}.category-container .badge{background-color:var(--primary-color-active);border-radius:5px;color:#fff;margin-left:5px;padding-left:4px;padding-right:4px}.post-list-container{direction:rtl;display:flex;flex-direction:row;flex-wrap:wrap;padding:3rem}.category-container{margin:2rem 1rem;width:calc(50% - 2rem)}.category-container .hr{background-color:var(--primary-color-active);border-radius:5px;height:5px;margin-bottom:1rem;margin-top:.1rem;width:40%}@media screen and (max-width:425px){.category-container{width:100%}.post-list-container{padding:1rem}}.social{display:flex;flex-direction:row;font-family:Source Code Pro!important;font-size:.9rem;justify-content:center;margin-top:20px;width:100%}.social a{color:grey!important;opacity:.6;transition:.2s}.social a:hover{opacity:1}.social p{margin-left:10px;margin-right:10px}</style><style>.gatsby-image-wrapper{position:relative;overflow:hidden}.gatsby-image-wrapper picture.object-fit-polyfill{position:static!important}.gatsby-image-wrapper img{bottom:0;height:100%;left:0;margin:0;max-width:none;padding:0;position:absolute;right:0;top:0;width:100%;object-fit:cover}.gatsby-image-wrapper [data-main-image]{opacity:0;transform:translateZ(0);transition:opacity .25s linear;will-change:opacity}.gatsby-image-wrapper-constrained{display:inline-block;vertical-align:top}</style><noscript><style>.gatsby-image-wrapper noscript [data-main-image]{opacity:1!important}.gatsby-image-wrapper [data-placeholder-image]{opacity:0!important}</style></noscript><script type="module">const e="undefined"!=typeof HTMLImageElement&&"loading"in HTMLImageElement.prototype;e&&document.body.addEventListener("load",(function(e){const t=e.target;if(void 0===t.dataset.mainImage)return;if(void 0===t.dataset.gatsbyImageSsr)return;let a=null,n=t;for(;null===a&&n;)void 0!==n.parentNode.dataset.gatsbyImageWrapper&&(a=n.parentNode),n=n.parentNode;const o=a.querySelector("[data-placeholder-image]"),r=new Image;r.src=t.currentSrc,r.decode().catch((()=>{})).then((()=>{t.style.opacity=1,o&&(o.style.opacity=0,o.style.transition="opacity 500ms linear")}))}),!0);</script><title data-react-helmet="true">JIT Compiler چیه و چطور کار می‌کنه؟ - قسمت ۴</title><link rel="sitemap" type="application/xml" href="/sitemap/sitemap-index.xml"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div class="main-container-wrapper"><div class="main-container"><h1>JIT Compiler چیه و چطور کار می‌کنه؟ - قسمت ۴</h1><div class="text">احتمالا شنیدید که کامپایلر یا Interpreter یک زبانی موقع اجرا کد اونو بهینه می‌کنه. مثلا توی پایتون اگه یک فانکشن زیاد اجرا بشه، Python Interpreter تصمیم میگیره که اونو بهینه کنه.
همینطور برای Ruby. زبان‌هایی مثل Dart و C# که کامپایل می‌شن هم داخل خودشون JIT دارن.
کلا به هر کامپایلری که موقع اجرای برنامه کد تولید و اجرا می‌کنه، بهش JIT Compiler می‌گن. توی این مقاله می‌خوایم با JIT Compiler ها آشنا بشیم و توی مقاله بعدی خواهیم دید که TurboFan که JIT Compiler داخل v8 هست چطور کار می‌کنه.</div><br/><h3>اصلا چرا JIT کردن لازمه؟</h3><br/><div class="text">بیایم اول برای ساده کردن مسئله فقط به زبان‌هایی که Dynamically Typed و بایت‌کد دارن نگاه کنیم.
مثل Python و JavaScript. امکان Dynamic Type بودن و Interpret شدن هر دو بی هزینه نیستن. بیایم اول ببینیم Interepret شدن چه هزینه‌ای داره:</div><div class="text">یک Interpreter یک برنامه‌ای هست که یک استریم از بایت‌کد (که یک برنامه دیگست) رو دریافت می‌کنه و اونو اجرا می‌کنه.
با اینکار اومدیم بجای اینکه مستقیم CPU Instruction بدیم به CPU که اون برامون اجرا کنه، یک لایه Indirection به اجرای برناممون اضافه کردیم. برای فهم بهتر این قضیه به این کد C نگاه کنید:</div><div style="position:relative"><div class="playground-button"><a target="_blank" href="https://godbolt.org/z/1Edaxds6W">Godbolt</a></div><pre class="prism-code language-c"><div class="token-line"><span class="token keyword">void</span><span class="token plain"> </span><span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">   </span><span class="token keyword">int</span><span class="token plain"> a </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">   </span><span class="token keyword">for</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> a </span><span class="token operator">+=</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><div class="text">کد بالا وقتی کامپایل می‌شه مستقیم تبدیل به همچینن کد اسمبلی خواهد شد:</div><div style="position:relative"><div class="playground-button"><a target="_blank" href="https://godbolt.org/z/1Edaxds6W">Godbolt</a></div><pre class="prism-code language-asm"><div class="token-line"><span class="token plain">main:</span></div><div class="token-line"><span class="token plain">        push    rbp</span></div><div class="token-line"><span class="token plain">        mov     rbp, rsp</span></div><div class="token-line"><span class="token plain">        mov     DWORD PTR [rbp-4], 0</span></div><div class="token-line"><span class="token plain">.L2:</span></div><div class="token-line"><span class="token plain">        add     DWORD PTR [rbp-4], 1</span></div><div class="token-line"><span class="token plain">        jmp     .L2</span></div></pre></div><div class="text">که درنهایت CPU مستقیم این کد اسمبلی رو اجرا می‌کنه. حالا بیایم فرض کنیم که کد C بالا رو بخواد یک Interpreter اجرا کنه.
اول باید تبدیلش کنیم به بایت کد که فرض کنیم همین کد اسمبلی بایت کد ما هم هست. Interpreter مون همچین چیزی میشه:</div><div style="position:relative"><div class="playground-button"><a target="_blank" href="https://godbolt.org/z/vc6xaMs15">Godbolt</a></div><pre class="prism-code language-c"><div class="token-line"><span class="token keyword">struct</span><span class="token plain"> </span><span class="token class-name">Instruction</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">int</span><span class="token plain"> type</span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token comment">// 0: Mov, 1: Add, 2: JMP</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">int</span><span class="token plain"> arg0</span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token comment">// A: 0</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">int</span><span class="token plain"> arg1</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">int</span><span class="token plain"> </span><span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">struct</span><span class="token plain"> </span><span class="token class-name">Instruction</span><span class="token plain"> code</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">{</span><span class="token plain"> type</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">,</span><span class="token plain"> arg0</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">,</span><span class="token plain"> arg1</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">0</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token comment">// MOV A, #0</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">{</span><span class="token plain"> type</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation">,</span><span class="token plain"> arg0</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">1</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain">          </span><span class="token comment">// ADD #1</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">{</span><span class="token plain"> type</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">2</span><span class="token punctuation">,</span><span class="token plain"> arg0</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">1</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain">          </span><span class="token comment">// JMP :1</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">int</span><span class="token plain"> ip </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">int</span><span class="token plain"> A </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">struct</span><span class="token plain"> </span><span class="token class-name">Instruction</span><span class="token plain"> current</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">for</span><span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">ip </span><span class="token operator">&gt;=</span><span class="token plain"> </span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token plain">code</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> </span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    current </span><span class="token operator">=</span><span class="token plain"> code</span><span class="token punctuation">[</span><span class="token plain">ip</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">switch</span><span class="token punctuation">(</span><span class="token plain">current</span><span class="token punctuation">.</span><span class="token plain">type</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token number">0</span><span class="token operator">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">switch</span><span class="token punctuation">(</span><span class="token plain">current</span><span class="token punctuation">.</span><span class="token plain">arg0</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token number">0</span><span class="token operator">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">              A </span><span class="token operator">=</span><span class="token plain"> current</span><span class="token punctuation">.</span><span class="token plain">arg1</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">              </span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token keyword">default</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token number">1</span><span class="token operator">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        A </span><span class="token operator">+=</span><span class="token plain"> current</span><span class="token punctuation">.</span><span class="token plain">arg0</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token number">2</span><span class="token operator">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        ip </span><span class="token operator">=</span><span class="token plain"> current</span><span class="token punctuation">.</span><span class="token plain">arg0</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">continue</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">default</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    ip </span><span class="token operator">+=</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><div class="text">خیلی واضح هست که کد بالا که نوشتیم نسبت به کد اولی که کد C ساده بود، کار بیشتری انجام می‌ده. هرچقدرم کار بیشتری انجام بدیم خب، کندتر هم برنامه اجرا می‌شه. این موضوع رو می‌تونیم با استفاده از godbolt که یک ابزار تحلیل خروجی کامپایلر هاست می‌تونیم واضح ببینیم.</div><br/><div class="text"><a class="img-container" href="/images/v8-jit-godbolt-1.png" target="_blank"><img src="/images/v8-jit-godbolt-1.png" alt="godbolt c code" dir="ltr"/></a></div><br/><br/><div class="text">حالا چرا Dynamically Type برای پرفرمنس بده؟ بیایم به داکیومنت EcmaScript یک نگاهی بندازیم و ببینیم اپراتور + چیکار می‌تونه بکنه.</div><div class="text"><a class="img-container" href="/images/v8-jit-ecma-1.png" target="_blank"><img src="/images/v8-jit-ecma-1.png" alt="ecma + operator" dir="ltr"/></a></div><br/><br/><div class="text">می‌دونیم که اگه توی جاوا اسکریپت دو تا استرینگ رو با <code dir="ltr">+</code> جمع کنیم، خروجی یک استرینگ دیگه خواهد بود.
یا اگه سمت چپ استرینگ و سمت راست عدد باشه، عدد تبدیل به استرینگ می‌شه و یک استرینگ دیگه تولید می‌شه و حالت های زیاد دیگه.
نکتش اینه که + توی جاوا اسکریپت با + توی C فرق می‌کنه.
توی C همیشه جمع عدد هست اما جاوا اسکریپت کارها و چک‌های زیادی می‌کنه.
خیلی واضح هست اینجا اگه می‌دونستیم از قبل که اگه تایپ چپ و راستمون چی هست، خیلی چک هارو لازم نبود انجام بدیم.</div><br/><div class="text"><a class="img-container" href="/images/v8-jit-ignition-code-1.png" target="_blank"><img src="/images/v8-jit-ignition-code-1.png" alt="ignition code" dir="ltr"/></a></div><br/><h3>چطور یک JIT Compiler کار می‌کنه؟</h3><br/><div class="text">حالا بیایم ببینیم چطوری می‌شه یک JIT Compiler نوشت.
فرض کنیم همچین تابعی داریم و میخوایم JIT Compile اش کنیم.</div><div style="position:relative"><pre class="prism-code language-javascript"><div class="token-line"><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">isNumberBigEnough</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">   </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">x </span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token number">5000</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">       </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">   </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><div class="text">هرجایی که ما این تابع رو صدا بزنیم interpreter میاد تابع رو پیدا میکنه و body داخلش رو Interept می‌کنه.</div><div class="text"><a class="img-container" href="/images/v8-jit-pt-1.png" target="_blank"><img src="/images/v8-jit-pt-1.png" alt="v8-jit-pt-1.png" dir="ltr"/></a></div><div class="text">الآن ما یک اشاره گر داریم به تابعی که می‌خواد تابع مارو Interpret و اجرا کنه. اگه یک تابعی در زبان هاستمون که مثلا اینجا C هست نوشته باشیم که کارش دقیقا همین isNumberBigEnough هست و این اشاره‌گر رو به اون تغییر بدیم، دیگه لازم نیست از Interpreter برای اجرا این تابع استفاده کنیم.</div><div class="text"><a class="img-container" href="/images/v8-jit-pt-2.png" target="_blank"><img src="/images/v8-jit-pt-2.png" alt="v8-jit-pt-2.png" dir="ltr"/></a></div><div class="text">مشکل اینجاست که ما نمی‌تونیم از قبل کلی تابع داشته باشیم و اینارو جایگزین کنیم چون کاربر می‌تونه هر نوع تابعی تعریف کنه. باید یک راه داینامیکی باشه که بشه کد اسمبلی توی راینتایم نوشت.
برای این مسئله، بیایم ببینیم بطور خیلی کلی و خلاصه یک باینری چطور اجرا میشه.</div><div class="text">اجرای یک باینری توی سیستم عامل های مختلف متفاوته ولی تقریبا همشون یکسری کانسپت شبیه به هم دارن.
وقتی ما یک برنامه رو اجرا می‌کنیم، اون فایل باینری توی مموری لود می‌شه. توی این فایلی که لود کردیم یک قسمتی داریم
به نام text section. این text section که توی همون مموری لود می‌شه که متغییرهامون رو تعریف می‌کنیم،
کدهامون هستن که مستقیم CPU اجراشون قراره بکنه.</div><div class="text"><a class="img-container" href="/images/v8-jit-elf-format.png" target="_blank"><img src="/images/v8-jit-elf-format.png" alt="v8-jit-elf-format.png" dir="ltr"/></a></div><div class="text">سکشن ها مختلف توی مموری یک برنامه‌مون یکسری فلگ دارن که مشخص میکنن مثلا این سکشن فقط خواندنی هست یا تایپش چیه.
یکی از این فلگ ها اینه که این تیکه از مموری قابل اجرا شدنه. text section هم همینطوره یک سکشن فقط خواندی قابل اجرا شدنه.
کد مثل استرینگ و عدد یک نوع داده هست، اگه ما بیایم یک تیکه از مموری رو داخلش کد بریزیم و مارکش کنیم
که این تیکه از مموری قابل اجرا شدنه، می‌تونیم یک تابع رو رانتایم به به برناممون اضافه کنیم!</div><blockquote><div class="text">اگه لینوکس دارید میتونید با این دستور سکشن های مختلف یک باینری رو ببینید
<code dir="ltr">objdump -d</code></div></blockquote><div class="text">اینکه دقیقا چطور میتونیم اینکارو بکنیم خارج از بحث این مقاله هست پس بیایم از یک کتابخونه استفاده کنیم که کارای سختو برای ما انجام داده و ما کافیه بهش کد اسمبلی بدیم
و اون برامون اونو توی یک تیکه مموری قرار می‌ده و calling convention رو هندل میکنه و درنهایت یک پوینتر به اون فانکشن بهمون میده!</div><div class="text">کتابخونه <a href="https://github.com/js-js/jit.js?files=1" dir="ltr">jit.js</a> یک کتابخونه مخصوص nodejs هست که اجازه میده اینکارو بکنیم.
(قطعا این کتابخونه توی محیط ایزوله شده کروم کار نخواهد کرد!)
مثال زیر یک تابعی درست میکنه که مقدار ۴۲ رو بر میگردونه.
توی اسمبلی رجیستر rax یک رجیستر خاص هست که مقدار خروجی تابع قبل از return داخلش قرار میگیره.</div><div style="position:relative"><pre class="prism-code language-javascript"><div class="token-line"><span class="token keyword">var</span><span class="token plain"> jit </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;jit.js&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">var</span><span class="token plain"> fn </span><span class="token operator">=</span><span class="token plain"> jit</span><span class="token punctuation">.</span><span class="token method function property-access">compile</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access maybe-class-name">Proc</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">mov</span><span class="token punctuation">(</span><span class="token string">&#x27;rax&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access maybe-class-name">Return</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></pre></div><div class="text">حالا کافیه ما یک jit compiler بنویسیم که اسمبلی که میخوایم رو تولید کنه و تابعمون رو به برنامه اضافه کنیم.
از آخر هم جای تابع interpretor برای <code dir="ltr">isNumberBigEnough</code> رو میتونیم با این تابعی که ساختیم عوض کنیم.</div><div class="text">این پست کوتاه یک پیش‌زمینه بود برای اینکه توی پست بعدی ببینیم TurboFan یا JitCompiler داخل v8 چطور کار میکنه و چطوری کدای جاوااسکریپت رو بهینه میکنه یا اصلا کی تصمیم میگیره این کارو بکنه.</div><blockquote><div class="text">خودم خیلی علاقه دارم خارج از این سری مربوط به v8 در مورد کامپیلرها و بهینه سازی پست های جدا و با جزئیات بیشتری بنویسم ولی نمیدونم چقدر برای مخاطب جالب میتونه باشه چون بلاگ پست های فوق العاده انگلیسی در مورد این موضوع هست و فرد علاقه‌مند از اون دسته پست احتمالا بهره بهتری می‌بره. در این زمان پیشنهاد می‌کنم اگر به موضوع علاقه‌مند هستید، به مراجع آخر نگاه بندازید</div></blockquote><hr/><h3>منابع</h3><div class="text">[<!-- -->1<!-- -->]<!-- -->: <a href="https://v8.dev/blog/turbofan-jit" dir="ltr">https://v8.dev/blog/turbofan-jit</a></div><div class="text">[<!-- -->2<!-- -->]<!-- -->: <a href="https://darksi.de/4.how-to-start-jitting/" dir="ltr">https://darksi.de/4.how-to-start-jitting/</a></div><div class="text">[<!-- -->3<!-- -->]<!-- -->: <a href="https://www.youtube.com/watch?v=mjHtadilm00&amp;ab_channel=WebRebels" dir="ltr">https://www.youtube.com/watch?v=mjHtadilm00&amp;ab_channel=WebRebels</a></div></div></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/v8-jit/";window.___webpackCompilationHash="5d11a3018239e5ed89ae";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app-982731c452ab10cb3a81.js"],"component---src-pages-404-tsx":["/component---src-pages-404-tsx-d479770c8c96c1ac42f2.js"],"component---src-pages-context-magic-mdx":["/component---src-pages-context-magic-mdx-4b4e4dbf7124a0b0fb00.js"],"component---src-pages-index-tsx":["/component---src-pages-index-tsx-3c265dab4f2e5fc09b32.js"],"component---src-pages-mp-games-mdx":["/component---src-pages-mp-games-mdx-990b5247268422324ec5.js"],"component---src-pages-posts-ive-read-mdx":["/component---src-pages-posts-ive-read-mdx-7e66f76db4947ad97b1a.js"],"component---src-pages-ratelimit-p-1-mdx":["/component---src-pages-ratelimit-p-1-mdx-ab74d2fc9b92877c5926.js"],"component---src-pages-ratelimit-p-2-mdx":["/component---src-pages-ratelimit-p-2-mdx-a831dc263d1b65146292.js"],"component---src-pages-usb-switcher-mdx":["/component---src-pages-usb-switcher-mdx-d2d9ce5fc9b3b3003e58.js"],"component---src-pages-v-8-ignition-mdx":["/component---src-pages-v-8-ignition-mdx-122560c660255bdbbf38.js"],"component---src-pages-v-8-jit-mdx":["/component---src-pages-v-8-jit-mdx-342275cde6b3adfce9f5.js"],"component---src-pages-v-8-mdx":["/component---src-pages-v-8-mdx-b1b5eabfe647d44e9a52.js"],"component---src-pages-v-8-parser-mdx":["/component---src-pages-v-8-parser-mdx-26d55d7ee79517093435.js"],"component---src-pages-working-memory-mdx":["/component---src-pages-working-memory-mdx-2b870071a2bbbc7332c9.js"]};/*]]>*/</script><script src="/app-982731c452ab10cb3a81.js" async=""></script><script src="/framework-2b6860fea1dc24d063ff.js" async=""></script><script src="/webpack-runtime-1085b16127d731830594.js" async=""></script></body></html>