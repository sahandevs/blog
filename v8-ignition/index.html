<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><link href="https://fonts.googleapis.com/css?family=Source Code Pro" rel="stylesheet"/><style data-href="/styles.9800d6fbb6096f7467c5.css" data-identity="gatsby-global-css">:root{--lr-padding:10px;--border-radius:8px;--primary-color-active:#ff7e14;--primary-color-inactive:#ffd1ac;--secondary-color:#fffcf9;--anim-duration:300ms;--paragraph-width:calc(min(760px, 100%));--code-width:min(100%,calc(var(--paragraph-width) + 12%));--paragraph-padding:calc(var(--code-width)/2 - var(--paragraph-width)/2);font-size:16px}.footnotes,.main-container h1,.text,a,em,h2,h3,h4,h5,h6,li,p,ul{direction:rtl;font-family:Vazir,monospace,Source Code Pro!important;line-height:1.6}.main-container h1,h2,h3,h4,h5,h6{padding-left:var(--paragraph-padding);padding-right:var(--paragraph-padding)}.text a{overflow-wrap:anywhere}.footnotes li{color:#5c6e74;font-size:.8rem!important}.main-container-wrapper{align-items:center;display:flex;flex-direction:column;width:100%}.main-container p{margin:0}a{text-decoration:none}a,a:hover{color:var(--primary-color-active)}a:hover{text-decoration:underline}.main-container{padding-top:1rem;width:var(--code-width)}.main-container img{display:block;margin-left:auto;margin-right:auto;max-height:500px;max-width:80%}.main-container .img-container{max-width:100%}@media screen and (max-width:768px){:root{--lr-padding:10%}}@media screen and (max-width:375px){:root{--lr-padding:5%}.main-container{margin-top:0;padding-top:0!important}.main-container h1{margin-top:10px}.main-container blockquote{margin:25px 0 0}.main-container img{max-width:100%;vertical-align:top}.main-container .img-container{overflow-x:auto}}.main-container li{font-size:1.2rem;margin-left:var(--paragraph-padding);margin-right:var(--paragraph-padding);margin-top:.6rem;padding:0;text-align:justify}.main-container p,.text{font-size:1.2rem;padding-left:var(--paragraph-padding);padding-right:var(--paragraph-padding);text-align:justify}.main-container blockquote .text{--h-space:10px;--v-space:4px;background-color:#e7e7e7;border-radius:var(--border-radius);border-right:5px solid var(--primary-color-inactive);margin-left:calc(var(--paragraph-padding)*1.3);margin-right:calc(var(--paragraph-padding)*1.3);padding:var(--v-space) var(--h-space);transition:border-right var(--anim-duration)}.main-container blockquote .text:hover{border-right-color:var(--primary-color-active)}.resources .text{direction:ltr;font-size:.8rem;text-align:start}.main-container code{background-color:#f1f1f1;border-radius:var(--border-radius);direction:ltr!important;font-size:1.1rem;padding-left:6px;padding-right:6px;text-align:left;white-space:nowrap}.playground-button{background-color:var(--primary-color-active);border-bottom-left-radius:var(--border-radius);padding:0 5px;position:absolute;right:0;top:0}.playground-button a{color:#fff;font-size:.8rem;margin:0}.playground-button a:hover{text-decoration:none}code[class*=language-],pre[class*=language-]{color:#5c6e74;direction:ltr;font-family:Source Code Pro,Andale Mono,Ubuntu Mono,monospace;font-size:1rem;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;text-align:left;text-shadow:none;white-space:pre;word-break:normal;word-spacing:normal}code[class*=language-]::mozselection,code[class*=language-]::selection,pre[class*=language-]::mozselection,pre[class*=language-]::selection{background:#b3d4fc;text-shadow:none}@media print{code[class*=language-],pre[class*=language-]{text-shadow:none}}pre[class*=language-]{background:var(--secondary-color);border:1px solid var(--primary-color-inactive);border-radius:var(--border-radius);margin:.5em 0;overflow:auto;padding:.8em;transition:border var(--anim-duration)}pre[class*=language-]:hover{border:1px solid var(--primary-color-active)}:not(pre)>code[class*=language-]{background:#f9f2f4;border-radius:.3em;color:#db4c69;padding:.1em .3em}.namespace{opacity:.7}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#93a1a1}.token.punctuation{color:#999}.token.boolean,.token.constant,.token.deleted,.token.number,.token.property,.token.symbol,.token.tag{color:#905}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string{color:#690}.language-css .token.string,.style .token.string,.token.entity,.token.operator,.token.url{background:#fff;color:#a67f59}.token.atrule,.token.attr-value,.token.keyword{color:#07a}.token.function{color:#dd4a68}.token.important,.token.regex,.token.variable{color:#e90}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}pre[data-line]{position:relative}pre[class*=language-]>code[class*=language-]{position:relative;z-index:1}.line-highlight{background:#f7ebc6;box-shadow:inset 5px 0 0 #f7d87c;left:0;line-height:inherit;margin-top:1em;padding-bottom:inherit;padding-left:0;padding-right:0;padding-top:inherit;pointer-events:none;position:absolute;right:0;white-space:pre;z-index:0}</style><meta name="generator" content="Gatsby 4.1.3"/><style>.gatsby-image-wrapper{position:relative;overflow:hidden}.gatsby-image-wrapper picture.object-fit-polyfill{position:static!important}.gatsby-image-wrapper img{bottom:0;height:100%;left:0;margin:0;max-width:none;padding:0;position:absolute;right:0;top:0;width:100%;object-fit:cover}.gatsby-image-wrapper [data-main-image]{opacity:0;transform:translateZ(0);transition:opacity .25s linear;will-change:opacity}.gatsby-image-wrapper-constrained{display:inline-block;vertical-align:top}</style><noscript><style>.gatsby-image-wrapper noscript [data-main-image]{opacity:1!important}.gatsby-image-wrapper [data-placeholder-image]{opacity:0!important}</style></noscript><script type="module">const e="undefined"!=typeof HTMLImageElement&&"loading"in HTMLImageElement.prototype;e&&document.body.addEventListener("load",(function(e){if(void 0===e.target.dataset.mainImage)return;if(void 0===e.target.dataset.gatsbyImageSsr)return;const t=e.target;let a=null,n=t;for(;null===a&&n;)void 0!==n.parentNode.dataset.gatsbyImageWrapper&&(a=n.parentNode),n=n.parentNode;const o=a.querySelector("[data-placeholder-image]"),r=new Image;r.src=t.currentSrc,r.decode().catch((()=>{})).then((()=>{t.style.opacity=1,o&&(o.style.opacity=0,o.style.transition="opacity 500ms linear")}))}),!0);</script><title data-react-helmet="true">Interpreter Ignition چیه و توی v8 چطوری کار می‌کنه؟ - قسمت ۳</title><meta data-react-helmet="true" charSet="utf-8"/><meta data-react-helmet="true" property="og:title" content="Interpreter Ignition چیه و توی v8 چطوری کار می‌کنه؟ - قسمت ۳"/><meta data-react-helmet="true" property="og:site_name" content="Sahand&#x27;s blog"/><link rel="sitemap" type="application/xml" href="/sitemap/sitemap-index.xml"/><link as="script" rel="preload" href="/webpack-runtime-83b7a170fdd479f1bdeb.js"/><link as="script" rel="preload" href="/framework-02d188296aa8e09a771c.js"/><link as="script" rel="preload" href="/app-dc3815e4c4a7b053095b.js"/><link as="script" rel="preload" href="/5e999c8c245179cb3a2ef9e4a39c885397d99ba6-e1e4b3fb83ceefdf6aa0.js"/><link as="script" rel="preload" href="/component---src-pages-v-8-ignition-mdx-81a18377b88f88e9a629.js"/><link as="fetch" rel="preload" href="/page-data/v8-ignition/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/app-data.json" crossorigin="anonymous"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div class="main-container-wrapper"><div class="main-container"><h1>Interpreter Ignition چیه و توی v8 چطوری کار می‌کنه؟ - قسمت ۳</h1><br/><div class="text"><a class="img-container" href="/images/v8-ignition-logo.png" target="_blank"><img src="/images/v8-ignition-logo.png" alt="v8-engine-ignition" dir="ltr" style="max-height:330px"/></a></div><br/><br/><div class="text">توی قسمت قبل در مورد این صحبت کردیم که چطور می‌تونیم کد جاوااسکریپت مون رو به یک فرمت قابل فهم برای کامپایلر تبدیل کنیم. حالا کامپایلر از این فرمت چطور می‌تونه استفاده کنه و یک کد رو اجرا کنه؟</div><h3>AST Interpreter</h3><div class="text">یک زبان ساده رو در نظر بگیریم که فقط عبارات ساده ریاضی توش کار می‌کنه. مثلا
‍<code dir="ltr">1 + 2</code>
و یا
<code dir="ltr">(1 + 1 + 3) * 4</code>.
اگه برای مثال دومی بیایم یک AST درست کنیم، همچین چیزی ممکنه بدست بیاد:</div><div class="text"><a class="img-container" href="/images/v8-ignition-ast-1.png" target="_blank"><img src="/images/v8-ignition-ast-1.png" alt="v8-ignition-ast-1.png" dir="ltr"/></a></div><div class="text">برای اینکه بتونیم یک درخت رو اجرا کنیم، باید از بالاترین Node که اینجا <code dir="ltr">Expression</code> هست شروع کنیم و مقدارش رو حساب کنیم.
بعضی از Node ها مثل همین <code dir="ltr">Expression</code> برای اینکه بتونن اجرا بشن نیاز دارن فرزندانشون اول اجرا بشن.
این کار رو تا جایی انجام میدیم که به اعداد تنها برسیم که دیگه فرزندی ندارن، حالا اعداد حساب شده رو دونه دونه از پایین به بالا می‌بریم تا در نهایت جواب آخر رو داشته باشیم.
حتمالا این توضیح زیاد واضح نبوده پس بیایم مثال بالا رو مرحله به مرحله حل بریم ببینم چی می‌شه.
از Node ریشه که اینجا <code dir="ltr">Expression</code> هست شروع می‌کنیم. این Node یک فرزند داره که می‌تونه یک عدد یا یک عبارت ریاضی باشه.
تو این مثال یک عبارت ریاضی هست به نام <code dir="ltr">Mul</code> که کار ضرب رو انجام می‌ده.
س باید اول ببینیم جواب <code dir="ltr">Mul</code> چی می‌شه.
خود <code dir="ltr">Mul</code> دو فرزند داره که از نوع <code dir="ltr">Expression</code> هستن.
قبل از اینکه جواب <code dir="ltr">Mul</code> رو داشته باشیم، باید جواب فرزند هارو بدست بیاریم و نتیجه رو در هم ضرب کنیم.
نتیجه می‌شه جواب <code dir="ltr">Mul</code>. فرزند سمت چپ اون یک عبارت دیگست که فرزندش یک عملیات ریاضی جمع هست.
مانند <code dir="ltr">Mul</code> دو فرزند داره و برای جوابش نیاز به جواب این دو فرزند داره. به فرزند دست چپ اگر نگاه کنیم یک عدد هست پس جواب فرزند دست چپ می‌شه همون عدد:</div><div class="text"><a class="img-container" href="/images/v8-ignition-ast-2.png" target="_blank"><img src="/images/v8-ignition-ast-2.png" alt="v8-ignition-ast-2.png" dir="ltr"/></a></div><div class="text">حالا باید فرزند دست راست رو حل کنه که باز خودش یک عمل جمع دیگست که دو فرزند عدد داره. جواب اونو بدست میاریم و بجای خودش می‌زاریم:</div><div class="text"><a class="img-container" href="/images/v8-ignition-ast-3.png" target="_blank"><img src="/images/v8-ignition-ast-3.png" alt="v8-ignition-ast-3.png" dir="ltr"/></a></div><div class="text">حالا که جواب سمت چپ و راست رو داریم می‌تونیم جواب نهایی عملیات جمع رو هم بدست بیاریم:</div><div class="text"><a class="img-container" href="/images/v8-ignition-ast-4.png" target="_blank"><img src="/images/v8-ignition-ast-4.png" alt="v8-ignition-ast-4.png" dir="ltr"/></a></div><div class="text">حالا جواب عبارت و سمت چپ <code dir="ltr">Mul</code> هم داریم. فرزند سمت راست اون هم یک عدد هست پس جواب سمت راستش هم موجوده. کافیه این دوتا رو در هم ضرب کنیم تا جواب <code dir="ltr">Mul</code> بدست بیاد:</div><div class="text"><a class="img-container" href="/images/v8-ignition-ast-5.png" target="_blank"><img src="/images/v8-ignition-ast-5.png" alt="v8-ignition-ast-5.png" dir="ltr"/></a></div><div class="text">و در آخر چون جواب Node ریشه برابر با Mul هست، جواب آخر هم همان می‌شود:</div><div class="text"><a class="img-container" href="/images/v8-ignition-ast-6.png" target="_blank"><img src="/images/v8-ignition-ast-6.png" alt="v8-ignition-ast-6.png" dir="ltr"/></a></div><div class="text">به این روش اجرا کردن یک کد، AST Interpreter و یا Visitor Pattern می‌گن که میایم هر Node رو تا پایین حل می‌کنیم و جواب رو تا بالا بر می‌گردونیم.
همچین روشی برای زبان ساده بالا ممکنه خوب جواب بده اما برای زبان پیچیده‌ای مثل جاوااسکریپت ممکنه خیلی مناسب نباشه. دلایل ریز زیادی داره اما چنتا از دلایل مهمش این ها هستن:</div><ul><li>برای پیاده سازی یک AST Interpreter نیاز داریم که از تعداد زیادی recursive فانکشن استفاده کنیم که این برای برنامه های پیچیده می‌تونه خیلی راحت bottleneck بشه.</li><li>فرمت کد درخت هست یعنی خوندن خود کد از مموری غیرخطیه. این باعث می‌شه زیاد نتونیم از Cache CPU برای نگه داشتن خود کد استفاده کنیم. مثلا اگر یک loop داشته باشیم که محاسبات سنگینی داخلش داره، بیشتر زمان محاسبه صرف این می‌شه که بریم کد رو از مموری بخونیم تا اینکه خود کد رو اجرا کنیم.</li><li>درسته که AST یک فرمت ساده‌تر از javascript پارس نشده هست، اما خود این فرمت هم نسبت به فرمتی که در ادامه این مقاله بهش می‌پردازیم سطح بالا هستش و برای اجرای بعضی از کد های جاوااسکریپت نیاز هست یکسری تحلیل هارو runtime انجام بدیم. تو مقاله قبل گفتم که برای اینکه بتونیم یک چیزی رو سریع کنیم باید کار کمتری انجام بدیم پس هرچقدر کار پیچیده انجام بدیم، اجرامون هم کندتر می‌شه.</li></ul><h3>Bytecode Interpreter</h3><div class="text">احتمالا حتی اگر کد assembly نزدید، نمونه هاشو دیدید. کد زیر یک نسخه ساده شده یک کد assembly هست:</div><div class="text"><a class="img-container" href="/images/v8-ignition-asm-1.png" target="_blank"><img src="/images/v8-ignition-asm-1.png" alt="v8-ignition-asm-1.png" dir="ltr"/></a></div><div class="text">هر خط کد از دو قسمت OpCode یا کد دستور و پارامتر های اون تشکیل می‌شه. توی مثال بالا از ۳ دستور مختلف استفاده کردیم.
دستور اول یا <code dir="ltr">MOV</code> میاد توی یک مکان حافظه یک مقدار رو منتقل می‌کنه.
پس توی خط اول داریم مقدار 1 رو داخل مکان B می‌ریزیم.
دستور <code dir="ltr">ADD</code> هم میاد پارامتر ورودی که بهش دادیم رو با A جمع می‌کنه و جوابشو داخل A می‌ریزه.
دستور <code dir="ltr">JMP</code> هم مثل goto کار می‌کنه. وقتی بهش رسیدیم برمی‌گردیم به جایی که دستور اشاره کرده.
گر دقت کرده باشید یک چیزی به نام <code dir="ltr">PC</code> داریم که یک اشاره گر به دستوری هست که قرارِ اجرا بشه.
بیام یک قدم بریم جلو:</div><div class="text"><a class="img-container" href="/images/v8-ignition-asm-2.png" target="_blank"><img src="/images/v8-ignition-asm-2.png" alt="v8-ignition-asm-2.png" dir="ltr"/></a></div><div class="text">دستور اول اجرا شد و مقدار B برابر 1 شد. یک مرحله دیگه کد رو اجرا کنیم:</div><div class="text"><a class="img-container" href="/images/v8-ignition-asm-3.png" target="_blank"><img src="/images/v8-ignition-asm-3.png" alt="v8-ignition-asm-3.png" dir="ltr"/></a></div><div class="text">مقدار A با B جمع شد و حاصلش رو ریختیم داخل A. الان A مقدار 1 و B هم مقدار 1 رو داره. بریم بعدی:</div><div class="text"><a class="img-container" href="/images/v8-ignition-asm-4.png" target="_blank"><img src="/images/v8-ignition-asm-4.png" alt="v8-ignition-asm-4.png" dir="ltr"/></a></div><div class="text">مقدار A رو با عدد 2 جمع می‌کنیم. حاصل می‌شه 3 که اونو می‌ریزیم توی A. حالا می‌رسیم به دستور ‍. این دستور تنها کاری که می‌کنه PC (که خودش یک پوینتر هست و پوینتر هم یک عددِ) رو تغییر می‌ده. با این کار مشخص می‌کنه کد بعدی که باید اجرا بشه چیه:</div><div class="text"><a class="img-container" href="/images/v8-ignition-asm-5.png" target="_blank"><img src="/images/v8-ignition-asm-5.png" alt="v8-ignition-asm-5.png" dir="ltr"/></a></div><div class="text">بر می‌گردیم بالا و اگه دو قدم بریم جلو دوباره به <code dir="ltr">JMP</code> می‌رسیم و A برابر با 6 می‌شه:</div><div class="text"><a class="img-container" href="/images/v8-ignition-asm-7.png" target="_blank"><img src="/images/v8-ignition-asm-7.png" alt="v8-ignition-asm-7.png" dir="ltr"/></a></div><div class="text">کد بالا تا توی یک چرخه می‌تونه اجرا بشه و مقدار A مدام عوض می‌شه. حالا کد زیر رو نگاه کنید:</div><div style="position:relative"><pre class="prism-code language-javascript"><div class="token-line"><span class="token keyword">let</span><span class="token plain"> </span><span class="token constant">A</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">let</span><span class="token plain"> </span><span class="token constant">B</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token constant">B</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword control-flow">while</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token constant">A</span><span class="token plain"> </span><span class="token operator">+=</span><span class="token plain"> </span><span class="token constant">B</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token constant">A</span><span class="token plain"> </span><span class="token operator">+=</span><span class="token plain"> </span><span class="token number">2</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><div class="text">کد اسمبلی مثال، مثل کد جاوااسکریپت بالا عمل می‌کنه.
اجرا کردن کد اسمبلی خیلی ساده‌ هست. یکسری دستور هست که یکسری عدد رو تغییر می‌دن و نه بیشتر از این.
گفتیم هرچه ساده‌تر و کار کمتر انجام بدیم، کد سریع‌تری خواهیم داشت. حالا اگه بتونیم کد جاوااسکریپت از AST به اسمبلی تبدیل کنیم،
می‌تونیم خیلی ساده‌تر از AST Interpreting هم اجراش کنیم.
مشکلی که اسمبلی داره اینه که برای هر CPU ای دستورات و معماری متفاوتی داره.
مرورگری مثل کروم که روی دستگاه ها و CPU مختلفی اجرا می‌شه نمی‌تونه صرفا کد جاوااسکریپت رو به یک اسمبلی CPU خاص تبدیل کنه.
برای همین خیلی از زبان ها تصمیم گرفتن بجای اینکه مستقیم تبدیل به اسمبلی کنن کد رو به Bytecode تبدیل کنن.
این Bytecode یک زبانی مثل اسمبلی هست اما با این تفاوت که یک لایه Abstraction روی معماری CPU می‌کشه تا روی معماری مختلف بتونه اجرا بشه.
اگر همچین چیزی داشته باشیم موقع تبدیل کد جاوااسکریپت به این مدل، نیاز نیست به معماری CPU هم فکر کنیم.
زبان های مختلف Bytecode های مختلف خودشون رو دارن.
مثلا C# فرمت IL و جاوا فرمت JVM Bytecode رو داره. جاوا اسکریپت هم Bytecode خودش رو داره که جلوتر فرمت و اینکه چطور اجرا می‌شه رو می‌بینیم.</div><h3>Ignition</h3><div class="text">بیایم برای کد جاوااسکریپت زیر ببینیم V8 چه Bytecode هایی براش درست می‌کنه. کد زیر رو داخل یک فایل با نام <code dir="ltr">test.js</code> ذخیره می‌کنیم:</div><div style="position:relative"><pre class="prism-code language-javascript"><div class="token-line"><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">test_fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">let</span><span class="token plain"> </span><span class="token constant">A</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">let</span><span class="token plain"> </span><span class="token constant">B</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token constant">B</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">while</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token constant">A</span><span class="token plain"> </span><span class="token operator">+=</span><span class="token plain"> </span><span class="token constant">B</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token constant">A</span><span class="token plain"> </span><span class="token operator">+=</span><span class="token plain"> </span><span class="token number">2</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token function">test_fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></pre></div><div class="text">سپس با با استفاده از NodeJs می‌تونیم با اجرای دستور زیر، Bytecode های تابع رو بدست بیاریم.</div><div style="position:relative"><pre class="prism-code language-sh"><div class="token-line"><span class="token plain">$ node --print-bytecode --print-bytecode-filter=test_fn test.js</span></div></pre></div><div class="text"><a class="img-container" href="/images/v8-ignition-ignition-1.png" target="_blank"><img src="/images/v8-ignition-ignition-1.png" alt="v8-ignition-ignition-1.png" dir="ltr"/></a></div><br/><div class="text">توی نگاه اول می‌بینیم یکسری تشابهاتی با کد اسمبلی فرضی مون داره. بیایم قسمت هایی که الان مهم نیستن رو پاک کنیم و ببینیم این Bytecode چه معنی ‌ای داره.</div><div class="text"><a class="img-container" href="/images/v8-ignition-ignition-2.png" target="_blank"><img src="/images/v8-ignition-ignition-2.png" alt="v8-ignition-ignition-2.png" dir="ltr"/></a></div><br/><div class="text">دستور اول یا <code dir="ltr">LdaZero</code> میاد داخل رجیستر (بخوانید یک مکان حافظه در پردازنده با دسترسی سریع) A (بخوانید رجیستر Accumulator) مقدار 0 رو می‌ریزه.
این رجیستر معمولا برای نگه داشتن نتیجه استفاده می‌شه.
اسم دستور از سه قسمت Ld به معنی <code dir="ltr">Load</code> کردن، <code dir="ltr">A</code> که نام رجیستر هست و <code dir="ltr">Zero</code> که مقدار ثابت صفر هست تشکیل می‌شه.
یعنی بیا مقدار 0 رو بریز توی A. اینکه چرا برای این رجیستر خاص و این مقدار خاص یک دستور جدا مشخص شده به این دلیل هست که این الگو خیلی استفاده می‌شه و کاربردی هست.
ا ساخت یک دستور جدا می‌شه اونو بهینه‌تر هم اجراش کرد چون لازم نیست برای هر بار اجرا چک کنیم مکان حافظه تارگتمون چی هست و می‌دونیم که همیشه رجیستر A خواهد بود.</div><div class="text">اگر به دستور بعدی نگاه کنیم، ساختار مشابهی داره. <code dir="ltr">Star0</code>. میاد مقدار <code dir="ltr">A</code> رو توی رجیستر <code dir="ltr">r0</code> میریزه که توی دستور قبلی این مقدار صفر بود. دو خط بعدی هم همینکارو با رجیستر <code dir="ltr">r1</code> انجام می‌دن.</div><div class="text">می‌رسیم به دستور <code dir="ltr">LdaSmi [1]</code>.
این دستور میاد داخل A یک عدد کوچیک می‌ریزه که اینجا عدد یک هست.
دستور بعد هم مقدار <code dir="ltr">A</code> رو داخل <code dir="ltr">r1</code> میریزه.
اگر دقت کرده باشید این چند خط اول دقیقا کار چند خط اول تابع مارو انجام میدن.
اینجا رجیستر <code dir="ltr">r0</code> همون <code dir="ltr">A</code> (متغییر با نام <code dir="ltr">A</code> و نه رجیستر <code dir="ltr">A</code>) هست و رجیستر <code dir="ltr">r1</code> همون <code dir="ltr">B</code>.</div><blockquote><div class="text">انجین تا جای ممکن سعی می‌کنه برای متغییر های اوکال از رجیستر استفاده کنه. اگه زیاد متغییر محلی یا برای تابع پارامتر داشتیم اونارو میاره توی استک.</div></blockquote><div class="text"><a class="img-container" href="/images/v8-ignition-ignition-3.png" target="_blank"><img src="/images/v8-ignition-ignition-3.png" alt="v8-ignition-ignition-3.png" dir="ltr"/></a></div><br/><div class="text">دستور <code dir="ltr">Add</code> و <code dir="ltr">AddSmi</code> اینطوری کار می‌کنن که پارامتری که بهشون می‌دیم رو با رجیستر A جمع می‌کنن و نتیجه رو داخل A می‌ریزن. ادامه کدمون پس این معنی رو می‌ده:</div><div class="text"><a class="img-container" href="/images/v8-ignition-ignition-4.png" target="_blank"><img src="/images/v8-ignition-ignition-4.png" alt="v8-ignition-ignition-4.png" dir="ltr"/></a></div><br/><div class="text">دستور <code dir="ltr">JumpLoop</code> مثل <code dir="ltr">JMP</code> که گفته بودیم عمل می‌کنه و میاد <code dir="ltr">PC</code> یا <code dir="ltr">IP</code> رو عوض می‌کنه.
با عوض کردن اون به قبل از دستور <code dir="ltr">A += B</code> در اصل ما همون حلقه بی‌نهیات تابعمون رو درست کردیم.
در نهایت می‌دونیم که اگه برای یک تابع <code dir="ltr">return</code> نزاریم بیش‌فرض مقدار <code dir="ltr">undefined</code> برمی‌گردونه، دو خط آخر همینکارو می‌کنن.</div><div class="text">این مواردی که گفته شد یعنی تبدیل کد جاوا اسکریپت از AST به Bytecode و اجرای اونو موتور Ignition یا Interpreter V8 انجام می‌ده.
این نکته رو در نظر داشته باشید که اگه خودتون دستورات بالا رو اجرا کردید ممکنه خروجی متفاوتی دریافت کنید
چون Bytecode ها توی هر ورژن ممکنه تغییر کنن همچنین یک نسخه جدید V8 می‌تونه استراتژی تولید کد متفاوتی داشته باشه.</div><div class="text">تو قسمت بعدی به این میپردازیم که v8 چطوری تصمیم میگیره یک قسمتی از کد رو optimize کنه.</div><hr/><h3>منابع</h3><div dir="rtl" class="resources"><div class="text">لیست بایت‌کد ها اینجا می‌تونید ببینید:</div><div class="text">[1]<!-- --> <a href="https://github.com/v8/v8/blob/main/src/interpreter/bytecodes.h" dir="ltr">https://github.com/v8/v8/blob/main/src/interpreter/bytecodes.h</a></div><div class="text">اینکه هر دستور چه چیزی رو اجرا می‌کنه هم می‌تونید کلیتش رو از اینجا متوجه بشید:</div><div class="text">[2]<!-- --> <a href="https://github.com/v8/v8/blob/main/src/maglev/maglev-graph-builder.cc" dir="ltr">https://github.com/v8/v8/blob/main/src/maglev/maglev-graph-builder.cc</a></div><div class="text">اگر براتون این بایت‌کد ها جالب بود حتما پیشنهاد میکنم این مقاله رو بخونید:</div><div class="text">[3]<!-- --> <a href="https://medium.com/dailyjs/understanding-v8s-bytecode-317d46c94775" dir="ltr">https://medium.com/dailyjs/understanding-v8s-bytecode-317d46c94775</a></div></div></div></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/v8-ignition/";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-d69664561c90ab43065f.js"],"app":["/app-dc3815e4c4a7b053095b.js"],"component---src-pages-404-tsx":["/component---src-pages-404-tsx-f320ba337d28ea2b66b6.js"],"component---src-pages-index-tsx":["/component---src-pages-index-tsx-598c6d4faa85a670f219.js"],"component---src-pages-ratelimit-p-1-mdx":["/component---src-pages-ratelimit-p-1-mdx-e6a2f79308b17ab1af8e.js"],"component---src-pages-ratelimit-p-2-mdx":["/component---src-pages-ratelimit-p-2-mdx-d396b307766e78b1a114.js"],"component---src-pages-v-8-ignition-mdx":["/component---src-pages-v-8-ignition-mdx-81a18377b88f88e9a629.js"],"component---src-pages-v-8-mdx":["/component---src-pages-v-8-mdx-a3e700e62668fa47202f.js"],"component---src-pages-v-8-parser-mdx":["/component---src-pages-v-8-parser-mdx-2d45c7f76e544a018b51.js"]};/*]]>*/</script><script src="/polyfill-d69664561c90ab43065f.js" nomodule=""></script><script src="/component---src-pages-v-8-ignition-mdx-81a18377b88f88e9a629.js" async=""></script><script src="/5e999c8c245179cb3a2ef9e4a39c885397d99ba6-e1e4b3fb83ceefdf6aa0.js" async=""></script><script src="/app-dc3815e4c4a7b053095b.js" async=""></script><script src="/framework-02d188296aa8e09a771c.js" async=""></script><script src="/webpack-runtime-83b7a170fdd479f1bdeb.js" async=""></script></body></html>